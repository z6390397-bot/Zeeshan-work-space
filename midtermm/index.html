<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Airline Satisfaction — Wide & Deep (TF.js)</title>
  <link rel="preconnect" href="https://cdn.jsdelivr.net"/>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4"></script>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
  <style>
    :root{ --bg:#0b0f17; --panel:#0f1524; --ink:#e9edf6; --muted:#a7b0c3; --border:rgba(255,255,255,.12); --glass:rgba(255,255,255,.06); }
    *{box-sizing:border-box}
    body{margin:0;padding:26px;background:linear-gradient(180deg,#0a0f1a,#0b0f17);color:var(--ink);font-family:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
    .wrap{max-width:1200px;margin:0 auto}
    h1{margin:0 0 10px 0}
    h2{margin:0 0 10px 0}
    .badge{display:inline-block;padding:4px 8px;border:1px solid var(--border);border-radius:8px;background:var(--glass);color:var(--muted)}
    .panel{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:16px;margin:16px 0}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    input[type="file"],button,select{background:var(--glass);color:var(--ink);border:1px solid var(--border);border-radius:10px;padding:8px 12px;cursor:pointer}
    button[disabled]{opacity:.6;cursor:not-allowed}
    button:hover:not([disabled]){outline:1px solid #8aa3ff}
    .kpis{display:flex;gap:12px;flex-wrap:wrap}
    .kpi{background:var(--glass);border:1px solid var(--border);border-radius:12px;padding:8px 12px}
    table{border-collapse:collapse;width:100%;background:var(--glass);border:1px solid var(--border)}
    th,td{padding:8px 10px;border-bottom:1px solid var(--border);font-size:.95rem}
    th{position:sticky;top:0;background:rgba(255,255,255,.05)}
    .scroll{max-height:320px;overflow:auto}
    pre{white-space:pre-wrap;background:var(--glass);border:1px solid var(--border);border-radius:12px;padding:12px}
    canvas{width:100%;height:280px;border:1px solid var(--border);border-radius:12px;background:#0f1628}
    .cm{display:grid;grid-template-columns:140px 90px 90px;gap:6px;align-items:center}
    .cm div{background:var(--glass);border:1px solid var(--border);padding:8px;border-radius:10px;text-align:center}
    .dot{display:inline-block;width:8px;height:8px;border-radius:50%;margin-right:6px;background:#6bd66b}
    .dot.busy{background:#f5a524;animation:pulse 1s infinite}
    @keyframes pulse{50%{transform:scale(1.2)}}
    /* EDA */
    .edagrid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
    @media(max-width:980px){.edagrid{grid-template-columns:1fr}}
    .echart{height:260px;border:1px solid var(--border);border-radius:12px;background:#0f1628}
  </style>
</head>
<body>
<div class="wrap">
  <h1>Airline Passenger Satisfaction — Wide & Deep (TF.js)</h1>
  <div class="badge">GPU/WebGL backend • smaller deep model • fewer epochs • bigger batch. Upload CSVs → Preprocess → Build → Train → ROC → Predict/Export. Now with EDA.</div>

  <div class="panel">
    <h2>Data Load</h2>
    <div class="row">
      <label>train.csv <input id="trainFile" type="file" accept=".csv"/></label>
      <label>test.csv <input id="testFile" type="file" accept=".csv"/></label>
      <button id="btnLoad">Load Files</button>
      <div class="kpis">
        <div class="kpi">Train rows: <b id="kTrain">—</b></div>
        <div class="kpi">Test rows: <b id="kTest">—</b></div>
        <div class="kpi">Missing%: <b id="kMiss">—</b></div>
        <div class="kpi">Repairs: <b id="fixNote">—</b></div>
      </div>
    </div>
    <div class="scroll" id="previewTable"></div>
  </div>

  <!-- EDA -->
  <div class="panel">
    <h2>Exploratory Data Analysis (EDA)</h2>
    <div class="row">
      <button id="btnEDA">Run EDA</button>
      <span class="badge">Charts are computed from <b>train.csv</b> in your browser.</span>
    </div>
    <div class="edagrid" style="margin-top:10px">
      <div><div id="edMissing" class="echart"></div></div>
      <div><div id="edGender"  class="echart"></div></div>
      <div><div id="edTravel"  class="echart"></div></div>
      <div><div id="edClass"   class="echart"></div></div>
      <div><div id="edAge"     class="echart"></div></div>
      <div><div id="edDist"    class="echart"></div></div>
      <div><div id="edDep"     class="echart"></div></div>
      <div><div id="edCorr"    class="echart"></div></div>
    </div>
  </div>

  <div class="panel">
    <h2>Preprocessing</h2>
    <div class="row">
      <label>Use case
        <select id="useCase">
          <option value="post">Post-flight recovery (allow ArrivalDelay)</option>
          <option value="pre">Pre-flight prediction (exclude ArrivalDelay)</option>
        </select>
      </label>
      <label><input id="featCross" type="checkbox" checked/> Cross: Class×TypeOfTravel</label>
      <label><input id="featDelay" type="checkbox" checked/> Feature: TotalDelay</label>
      <button id="btnPre">Run Preprocessing</button>
    </div>
    <pre id="preInfo">—</pre>
  </div>

  <div class="panel">
    <h2>Model (Wide & Deep)</h2>
    <div class="row">
      <button id="btnBuild">Build Model</button>
      <button id="btnSummary">Show Summary</button>
    </div>
    <pre id="modelSummary">—</pre>
  </div>

  <div class="panel">
    <h2>Training</h2>
    <div class="row" style="gap:16px;">
      <button id="btnTrain">Train (25 epochs)</button>
      <button id="btnStop">Early Stop</button>
      <span class="badge" id="trainStatus"><span id="trainDot" class="dot"></span><span id="trainText">Idle</span></span>
    </div>
    <pre id="trainLog">—</pre>
  </div>

  <div class="panel">
    <h2>Metrics</h2>
    <div class="row" style="gap:16px;align-items:center">
      <div>Threshold: <b id="thVal">0.50</b></div>
      <input id="thSlider" type="range" min="0" max="1" step="0.01" value="0.5" style="width:280px"/>
      <div>AUC: <b id="aucText">—</b></div>
    </div>
    <canvas id="rocCanvas" width="900" height="300"></canvas>
    <div class="row" style="margin-top:10px">
      <div class="cm">
        <div></div><div><b>Pred 1</b></div><div><b>Pred 0</b></div>
        <div><b>True 1</b></div><div id="cmTP">0</div><div id="cmFN">0</div>
        <div><b>True 0</b></div><div id="cmFP">0</div><div id="cmTN">0</div>
      </div>
      <pre id="prf" style="flex:1;margin-left:12px">—</pre>
    </div>
  </div>

  <div class="panel">
    <h2>Predict & Export</h2>
    <div class="row">
      <button id="btnPredict">Predict test.csv</button>
      <button id="btnSub">Download submission.csv</button>
      <button id="btnProb">Download probabilities.csv</button>
      <button id="btnSaveModel">Save model</button>
    </div>
    <pre id="predInfo">—</pre>
  </div>
</div>

<script>
  // Prefer GPU (WebGL); fall back to CPU if not available.
  (async ()=>{
    for (const b of ['webgl','cpu']) {
      try { await tf.setBackend(b); await tf.ready(); if (tf.getBackend()===b) break; } catch {}
    }
    console.log('TF backend:', tf.getBackend());
  })();
</script>
<script src="app.js"></script>
</body>
</html>
